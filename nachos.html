<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Comfort Caf√© ‚Äî Our Storybook for My Cutie</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#fff5f7;
  --bg2:#fff0ee;
  --wood:#f6e7e5;
  --pink:#ff6b95;
  --rose:#d64b76;
  --accent:#ff9dbb;
  --muted:#5a2a3c;
  --card-shadow:0 12px 34px rgba(214,75,118,0.08);
  --fruit-size:54px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Montserrat,system-ui,Arial;color:var(--muted);background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:28px auto;padding:18px}
.header{
  display:flex;gap:18px;align-items:center;justify-content:space-between;
  background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,250,250,0.95));
  padding:18px;border-radius:14px;box-shadow:var(--card-shadow);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:74px;height:74px;border-radius:12px;background:linear-gradient(135deg,var(--pink),var(--rose));
  display:flex;align-items:center;justify-content:center;color:white;font-size:32px;font-weight:800;box-shadow:0 8px 20px rgba(214,75,118,0.12);
}
.title{font-family:'Playfair Display',serif;font-size:20px;color:var(--rose)}
.tag{font-size:13px;color:#7a3946}
.open-btn{padding:10px 14px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--pink),var(--accent));color:white;font-weight:700;cursor:pointer;box-shadow:0 10px 28px rgba(255,107,149,0.18)}

/* main layout */
.main{display:grid;grid-template-columns:340px 1fr;gap:18px;margin-top:18px}
@media(max-width:920px){.main{grid-template-columns:1fr}}
.sidebar{background:linear-gradient(180deg,#fff,#fff6fb);padding:14px;border-radius:12px;box-shadow:var(--card-shadow)}
.cafe-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--rose);margin-bottom:8px}
.menu{display:flex;flex-direction:column;gap:8px}
.menu button{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,#fff,#fff6f9);cursor:pointer;font-weight:700;color:var(--rose)}
.menu small{display:block;font-weight:400;color:#7a3946;font-size:12px}

/* story / chapter area */
.story{background:linear-gradient(180deg,#fff,#fff7fb);padding:18px;border-radius:12px;box-shadow:var(--card-shadow);min-height:520px;position:relative;overflow:hidden}
.chapter-controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
.chp-tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:999px;background:linear-gradient(90deg,#fff,#fff6f9);cursor:pointer;border:1px solid rgba(214,75,118,0.06);font-weight:700;color:var(--rose)}
.tab.active{background:linear-gradient(90deg,var(--pink),var(--accent));color:white;box-shadow:0 8px 20px rgba(255,107,149,0.16)}
.chapter{display:none;animation:fadeContent .42s ease forwards}
.chapter.active{display:block}
@keyframes fadeContent {from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* chapter content styling */
.card{background:white;padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.04)}
.hug{padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff6fb,#fff1f5);margin-top:12px}
.poem{font-family:'Playfair Display',serif;font-size:16px;color:#4c2a33;line-height:1.6}

/* discord mockup */
.discord{background:#f5f7fb;padding:12px;border-radius:10px;margin-top:10px}
.msg{display:flex;gap:10px;margin-bottom:10px}
.avatar-sm{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--pink),var(--rose));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.bubble{padding:8px 12px;border-radius:12px;background:white;box-shadow:0 6px 16px rgba(0,0,0,0.04);max-width:78%}
.me .bubble{background:linear-gradient(90deg,#fff6fb,#fff0f3)}
.time{font-size:11px;color:#9b6a74;margin-top:6px}

/* game area */
.game{margin-top:12px}
.game-stage{height:260px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff6fb);position:relative;border:1px dashed rgba(214,75,118,0.06);overflow:hidden}
.game-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.timer{font-weight:800;color:var(--rose);font-size:18px}
.score{font-weight:700;color:#5a2a3c}

/* gun cursor */
.gun{position:fixed;z-index:9999;pointer-events:none;width:48px;height:48px;display:none;align-items:center;justify-content:center;font-size:22px;transform:translate(-50%,-50%) rotate(-8deg)}

/* fruits stage */
.fruit-stage{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:20;overflow:hidden}
.fruit{position:absolute;border-radius:12px;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;pointer-events:none;width:var(--fruit-size);height:var(--fruit-size);box-shadow:0 8px 18px rgba(0,0,0,0.08)}
.fruit .face{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.14);padding:4px 6px;border-radius:8px;font-size:11px;color:#401d24;font-weight:700}
.fruit .eyes{position:absolute;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.eye{width:6px;height:6px;border-radius:50%;background:#401d24}

/* fruit variants */
.straw{background:linear-gradient(135deg,#ff6b95,#ff3b7a)}
.melon{background:linear-gradient(135deg,#ffd66b,#ffaf3b);color:#401d24}
.grape{background:linear-gradient(135deg,#9b59ff,#7b2be6)}
.banana{background:linear-gradient(135deg,#ffd97a,#ffb84a);color:#401d24}
.apple{background:linear-gradient(135deg,#ff8b8b,#ff4b4b)}
.pear{background:linear-gradient(135deg,#b7f17d,#8fd13a);color:#401d24}

/* wiggle animation (M2) */
@keyframes wiggle {
  0%{ transform: translateY(0) rotate(-4deg) scale(0.98) }
  25%{ transform: translateY(-6px) rotate(4deg) scale(1.02) }
  50%{ transform: translateY(0) rotate(-2deg) scale(1) }
  75%{ transform: translateY(-4px) rotate(6deg) scale(1.03) }
  100%{ transform: translateY(0) rotate(-4deg) scale(0.98) }
}
@keyframes bounceShort {
  0%{ transform: translateY(0) }
  50%{ transform: translateY(-10px) }
  100%{ transform: translateY(0) }
}

/* small utilities */
.row{display:flex;gap:8px;align-items:center}
.small{font-size:13px;color:#7a3946}
.center{text-align:center}
.footer{margin-top:18px;text-align:center;color:#7a3946}

/* popup */
.popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:white;padding:16px;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,0.18);z-index:10001;display:none}
.popup.show{display:block}
</style>
</head>
<body>
  <!-- fruits stage -->
  <div id="fruitStage" class="fruit-stage" aria-hidden="true"></div>

  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">üíï</div>
        <div>
          <div class="title">Comfort Caf√© ‚Äî Our Storybook</div>
          <div class="tag">A cozy place I made for you. I‚Äôm here ‚Äî always.</div>
        </div>
      </div>
      <div class="row">
        <button id="openCafe" class="open-btn">Open Our Caf√©</button>
      </div>
    </header>

    <div class="main" id="mainArea" aria-hidden="true" style="display:none">
      <!-- left: menu / chapters -->
      <aside class="sidebar">
        <div class="cafe-title">Menu ‚Äî Chapters</div>
        <div class="menu" role="tablist" aria-label="Story chapters">
          <button class="menu-item tab-btn" data-ch="1"><strong>‚òï Chapter 1</strong><small>It started with a game</small></button>
          <button class="menu-item tab-btn" data-ch="2"><strong>üí¨ Chapter 2</strong><small>Midnights & Discord</small></button>
          <button class="menu-item tab-btn" data-ch="3"><strong>üêæ Chapter 3</strong><small>Maui & Roxy</small></button>
          <button class="menu-item tab-btn" data-ch="4"><strong>üéß Chapter 4</strong><small>Your music</small></button>
          <button class="menu-item tab-btn" data-ch="5"><strong>üíó Chapter 5</strong><small>Your safe space</small></button>
          <button class="menu-item tab-btn" data-ch="6"><strong>üåô Chapter 6</strong><small>Rest & baby me</small></button>
          <button class="menu-item tab-btn" data-ch="7"><strong>üîÆ Chapter 7</strong><small>Today & tomorrow</small></button>
        </div>

        <div style="margin-top:12px" class="card">
          <div style="font-weight:800;color:var(--rose)">Spoil Menu</div>
          <div class="small" style="margin-top:6px">McFloat, ShakeShake Fries, extra cuddles ‚Äî I‚Äôll bring them in your dreams.</div>
          <div style="margin-top:8px" class="row">
            <button id="spoilBtn" class="open-btn" style="padding:8px 12px;font-size:13px">Spoil Her</button>
            <button id="fruitToggle" class="tab-btn" style="padding:8px 12px;font-size:13px">Fruits ON</button>
          </div>
        </div>

      </aside>

      <!-- right: story pane -->
      <section class="story" id="storyPane" aria-live="polite">
        <div class="chapter-controls">
          <div class="chp-tabs" id="tabsRow">
            <div class="tab active" data-ch="1">Chapter 1</div>
            <div class="tab" data-ch="2">Chapter 2</div>
            <div class="tab" data-ch="3">Chapter 3</div>
            <div class="tab" data-ch="4">Chapter 4</div>
            <div class="tab" data-ch="5">Chapter 5</div>
            <div class="tab" data-ch="6">Chapter 6</div>
            <div class="tab" data-ch="7">Chapter 7</div>
          </div>
          <div class="row">
            <div class="small">Chapter <span id="currentCh">1</span> / 7</div>
            <div style="width:8px"></div>
            <button id="nextBtn" class="tab-btn">Next ‚Üí</button>
          </div>
        </div>

        <!-- Chapter 1 -->
        <article id="ch-1" class="chapter active" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 1 ‚Äî It started with a game</h3>
            <p class="small" style="margin-top:8px">Remember Valorant? That first clutch, the silly banters, the moment I thought ‚Äúwow ‚Äî this one is special.‚Äù</p>

            <div class="hug">
              <p style="margin:0">I remember the rounds we shared, the laugh you made right after a crazy play, the way you typed "im here" after a hectic match ‚Äî and it felt like home. This chapter holds that spark.</p>
            </div>

            <div class="game" style="margin-top:12px">
              <div class="game-top">
                <div class="timer" id="miniTimer">20s</div>
                <div class="score">Score: <span id="miniScore">0</span></div>
              </div>
              <div id="miniStage" class="game-stage" aria-label="Valorant mini-game area"></div>
              <div class="small" style="margin-top:8px">Start the mini-game to pop hearts ‚Äî playful memory of our matches.</div>
              <div style="margin-top:8px" class="row">
                <button id="startMini" class="open-btn" style="padding:8px 12px;font-size:13px">Start Game</button>
                <button id="resetMini" class="tab-btn" style="padding:8px 12px;font-size:13px">Reset</button>
              </div>
            </div>
          </div>
        </article>

        <!-- Chapter 2 -->
        <article id="ch-2" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 2 ‚Äî Midnights & Discord</h3>
            <p class="small" style="margin-top:8px">Those long chats, the silly clips, our naughty banter that somehow makes everything lighter ‚Äî this is our place to laugh and be real.</p>

            <div class="discord" style="margin-top:10px" aria-hidden="false">
              <div class="msg her">
                <div class="avatar-sm">R</div>
                <div>
                  <div class="bubble">ihhh... no na üò≥</div>
                  <div class="time">Her ‚Ä¢ 11:07 PM</div>
                </div>
              </div>
              <div class="msg me">
                <div class="avatar-sm" style="background:linear-gradient(135deg,#ffd5e6,#ff9dbb)">U</div>
                <div>
                  <div class="bubble">stop being cute, answer my question</div>
                  <div class="time">You ‚Ä¢ 11:07 PM</div>
                </div>
              </div>
              <div class="msg her">
                <div class="avatar-sm">R</div>
                <div>
                  <div class="bubble">eep na ako üíï</div>
                  <div class="time">Her ‚Ä¢ 11:08 PM</div>
                </div>
              </div>
              <div class="msg her">
                <div class="avatar-sm">R</div>
                <div>
                  <div class="bubble">i wub u ‚Äî awabyuu</div>
                  <div class="time">Her ‚Ä¢ 11:08 PM</div>
                </div>
              </div>
              <div class="msg me">
                <div class="avatar-sm" style="background:linear-gradient(135deg,#ffd5e6,#ff9dbb)">U</div>
                <div>
                  <div class="bubble">kiss? isa? üòΩ</div>
                  <div class="time">You ‚Ä¢ 11:09 PM</div>
                </div>
              </div>
              <div class="msg her">
                <div class="avatar-sm">R</div>
                <div>
                  <div class="bubble">im here üíó</div>
                  <div class="time">Her ‚Ä¢ 11:09 PM</div>
                </div>
              </div>
            </div>

          </div>
        </article>

        <!-- Chapter 3 -->
        <article id="ch-3" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 3 ‚Äî Maui & Roxy</h3>
            <p class="small" style="margin-top:8px">You have these little worlds ‚Äî Maui‚Äôs memories and Roxy‚Äôs purrs. I love how they soften you. I love watching you with them.</p>

            <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
              <div style="font-size:48px">üê±üê∂</div>
              <div>
                <div style="font-weight:800;color:var(--rose)">Roxy</div>
                <div class="small">Your cuddle partner, your softie friend ‚Äî I promise to cuddle them too when you nap.</div>
                <div style="height:8px"></div>
                <div style="font-weight:800;color:var(--rose)">Maui</div>
                <div class="small">A memory that we keep safe and warm together.</div>
              </div>
            </div>

          </div>
        </article>

        <!-- Chapter 4 -->
        <article id="ch-4" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 4 ‚Äî Your Music</h3>
            <p class="small" style="margin-top:8px">You and your songs ‚Äî you hum along and I listen. Here are little chimes inspired by your faves.</p>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="jereBtn" class="open-btn" style="padding:8px 12px;font-size:14px">Play Jereena</button>
              <button id="nikiBtn" class="tab-btn" style="padding:8px 12px;font-size:14px">Play NIKI</button>
              <button id="ariBtn" class="tab-btn" style="padding:8px 12px;font-size:14px">Play Ariana</button>
            </div>

            <div class="small" style="margin-top:10px">(Taps produce gentle chimes ‚Äî click once to hear.)</div>
          </div>
        </article>

        <!-- Chapter 5 -->
        <article id="ch-5" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 5 ‚Äî Your Safe Space</h3>
            <p class="small" style="margin-top:8px">If you ever feel alone, click the comforts below ‚Äî little messages and affirmations I wrote just for you.</p>

            <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
              <button class="tab-btn comfort" data-msg="It‚Äôs okay to rest. I‚Äôll hold things while you breathe.">It‚Äôs okay to rest</button>
              <button class="tab-btn comfort" data-msg="You are loved. I am here. No questions asked.">You are loved</button>
              <button class="tab-btn comfort" data-msg="Your laugh is my favorite song. Thank you for it.">Your laugh</button>
              <button class="tab-btn comfort" data-msg="When life is heavy, lean on me ‚Äî I‚Äôm not going anywhere.">Lean on me</button>
            </div>
          </div>
        </article>

        <!-- Chapter 6 -->
        <article id="ch-6" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 6 ‚Äî Rest, baby</h3>
            <p class="small" style="margin-top:8px">For the sleepy gamer who loves to be babied: gentle lullabies, a soft poem, and a tiny "I‚Äôm here" button.</p>

            <div class="poem" style="margin-top:10px">
              <p>Rest, my soft one ‚Äî let the night take your edges,</p>
              <p>I‚Äôll warm your cup and whisper sleepy songs,</p>
              <p>Roxy curls, Maui‚Äôs memory hums,</p>
              <p>I am here. Close your eyes; I‚Äôll stay.</p>
            </div>

            <div style="margin-top:10px" class="row">
              <button id="imHere" class="open-btn" style="padding:10px 12px">I‚Äôm here ‚Äî (press)</button>
              <div id="hereEcho" class="small" style="margin-left:8px"></div>
            </div>
          </div>
        </article>

        <!-- Chapter 7 -->
        <article id="ch-7" class="chapter" role="tabpanel">
          <div class="card">
            <h3 style="margin:0;color:var(--rose);font-family:'Playfair Display',serif">Chapter 7 ‚Äî Today & Tomorrow</h3>
            <p class="small" style="margin-top:8px">I choose you today. I choose you tomorrow. I promise to spoil and cherish you.</p>

            <div class="hug" style="margin-top:12px">
              <p style="margin:0">You deserve the best in this world. I‚Äôll give it to you ‚Äî not because I owe you, but because my favorite thing is to see you smile. See you on our third month, and every month after. awabyuu üíó</p>
            </div>
          </div>
        </article>

      </section>
    </div>

    <div class="footer center small">Made with love ‚Äî for my cutie who loves Maui, Roxy, music, late-night Valorant & sleepy cuddles.</div>
  </div>

  <!-- gun cursor for mini-game (V2) -->
  <div id="gunCursor" class="gun">üî´</div>

  <!-- popup -->
  <div id="popup" class="popup" role="dialog" aria-modal="true"><div id="popupContent"></div></div>

<script>
/* ---------------------------
  Initialization
--------------------------- */
const openCafeBtn = document.getElementById('openCafe');
const mainArea = document.getElementById('mainArea');
const fruitStage = document.getElementById('fruitStage');
const tabs = document.querySelectorAll('.tab');
const tabBtns = document.querySelectorAll('.tab-btn');
const chCurrent = document.getElementById('currentCh');
const nextBtn = document.getElementById('nextBtn');
const popup = document.getElementById('popup');
const popupContent = document.getElementById('popupContent');
const gunCursor = document.getElementById('gunCursor');

let currentChapter = 1;
const CH_COUNT = 7;
let fruitsOn = true;

/* show cafe */
openCafeBtn.addEventListener('click', ()=> {
  mainArea.style.display = 'grid';
  mainArea.removeAttribute('aria-hidden');
  openCafeBtn.disabled = true;
  // start fruits and typing
  startFruits();
  startTyping();
  showPopup('<div style="font-weight:800;color:#d64b76">Welcome to our Comfort Caf√© ‚òïÔ∏è</div><div class="small" style="margin-top:8px">Click chapters at left or the tabs above.</div>');
});

/* tabs click */
tabs.forEach(t => t.addEventListener('click', ()=> switchChapter(parseInt(t.dataset.ch))));
tabBtns.forEach(b => b.addEventListener('click', ()=> {
  const ch = b.dataset.ch ? parseInt(b.dataset.ch) : null;
  if(ch) switchChapter(ch);
}));

nextBtn.addEventListener('click', ()=> {
  const next = Math.min(CH_COUNT, currentChapter + 1);
  switchChapter(next);
});

/* switch chapter function */
function switchChapter(n) {
  currentChapter = n;
  chCurrent.textContent = n;
  // activate tab visuals
  tabs.forEach(t => t.classList.toggle('active', parseInt(t.dataset.ch) === n));
  // show/hide articles
  for(let i=1;i<=CH_COUNT;i++){
    const el = document.getElementById('ch-' + i);
    if(el) el.classList.toggle('active', i === n);
  }
  // small fruit dance on chapter change
  if(fruitsOn) littleFruitBurst(6);
}

/* popup helper */
function showPopup(html) {
  popupContent.innerHTML = html;
  popup.classList.add('show');
  setTimeout(()=> popup.classList.remove('show'), 3600);
}

/* ---------------------------
  Typing phrases loop (chapter 1 header small)
--------------------------- */
const typingPhrases = ['ihhh... no na üò≥','please... eep na ako üíï','i wub u ‚Äî awabyuu ‚ù§Ô∏è','im here üíó','kiss? isa? üòΩ'];
let tpIndex = 0;
function startTyping(){
  const el = document.querySelector('.title') || document.createElement('div');
  // small effect in chapter area header: use setInterval to gently rotate phrase on sidebar (we can show in console)
  const smallEl = document.createElement('div');
  smallEl.className = 'small';
  smallEl.style.marginTop = '8px';
  smallEl.textContent = typingPhrases[tpIndex];
  // append under the header title
  const header = document.querySelector('.tag');
  if(header) header.insertAdjacentElement('afterend', smallEl);
  setInterval(()=> {
    tpIndex = (tpIndex + 1) % typingPhrases.length;
    smallEl.textContent = typingPhrases[tpIndex];
  }, 2400);
}

/* ---------------------------
  Fruits implementation (F2 + M2 + medium)
--------------------------- */
const FRUITS = ['straw','melon','grape','banana','apple','pear'];
let fruitPool = [];
let fruitTimer;

function makeFruit(){
  const el = document.createElement('div');
  el.className = 'fruit ' + FRUITS[Math.floor(Math.random()*FRUITS.length)];
  // position random
  el.style.left = (Math.random()*84 + 4) + 'vw';
  el.style.top = (Math.random()*84 + 4) + 'vh';
  // face & eyes
  const eyes = document.createElement('div'); eyes.className = 'eyes';
  const e1 = document.createElement('div'); e1.className = 'eye';
  const e2 = document.createElement('div'); e2.className = 'eye';
  eyes.appendChild(e1); eyes.appendChild(e2);
  const face = document.createElement('div'); face.className = 'face';
  const faces = ['üôÇ','üòØ','üòù','ü•∫','üòã','üòç','ü§≠','ü§©','üòÅ'];
  face.textContent = faces[Math.floor(Math.random()*faces.length)];
  el.appendChild(eyes); el.appendChild(face);
  // wiggle speed
  const speed = (Math.random()*2 + 3.2).toFixed(2) + 's';
  el.style.animation = `wiggle ${speed} ease-in-out ${Math.random()*0.6}s infinite`;
  // sometimes bounce
  if(Math.random() > 0.6) el.style.animation += `, bounceShort ${1.6 + Math.random()*1}s ease-in-out ${Math.random()*3}s infinite`;
  // small horizontal drift stored
  el.dataset.vx = (Math.random()*0.6 - 0.3).toFixed(3);
  fruitStage.appendChild(el);
  fruitPool.push(el);
  // keep pool size manageable (remove oldest)
  if(fruitPool.length > 18){ const old = fruitPool.shift(); try{ old.remove(); }catch(e){} }
  return el;
}

function spawnFruits(count=14){
  // clear then create
  fruitStage.innerHTML = '';
  fruitPool = [];
  for(let i=0;i<count;i++) makeFruit();
  // drift loop
  if(fruitTimer) clearInterval(fruitTimer);
  fruitTimer = setInterval(()=> {
    fruitPool.forEach(el => {
      const vx = parseFloat(el.dataset.vx) || 0;
      let left = parseFloat(el.style.left) || 0;
      left += vx * 1.2;
      if(left < 2) left = 2;
      if(left > 92) left = 92;
      el.style.left = left + 'vw';
      // occasional expression change
      if(Math.random() < 0.018){
        const faces = ['üôÇ','üòØ','üòù','ü•∫','üòã','üòç','ü§≠','ü§©','üòÅ'];
        const faceEl = el.querySelector('.face');
        if(faceEl) faceEl.textContent = faces[Math.floor(Math.random()*faces.length)];
      }
    });
  }, 260);
}

function startFruits(){
  fruitsOn = true;
  spawnFruits(14);
  // periodic slight respawn shaking
  setInterval(()=> {
    if(!fruitsOn) return;
    // small wiggle burst occasionally
    fruitPool.forEach(el => { if(Math.random() < 0.12) el.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:480,iterations:1}); });
  }, 2500);
}

function littleFruitBurst(n=6){
  // spawn a few temporary fruits that dance then fade
  for(let i=0;i<n;i++){
    const f = makeFruit();
    f.style.opacity = '0';
    setTimeout(()=> f.style.opacity = '1', 60 + i*40);
    // remove after short while
    setTimeout(()=> { try{ f.remove(); }catch(e){} }, 3600 + Math.random()*1200);
  }
}

/* toggle fruits */
document.getElementById('fruitToggle').addEventListener('click', function(){
  fruitsOn = !fruitsOn;
  this.textContent = fruitsOn ? 'Fruits ON' : 'Fruits OFF';
  if(fruitsOn) startFruits(); else { fruitStage.innerHTML=''; fruitPool=[]; if(fruitTimer) clearInterval(fruitTimer); }
});

/* Spoil button */
document.getElementById('spoilBtn').addEventListener('click', ()=> {
  littleFruitBurst(10);
  showPopup('<div style="font-weight:800;color:#d64b76">Spoiling time! üçüü•§</div><div class="small" style="margin-top:6px">Imagining ShakeShake BBQ + McFloat delivered with extra hugs.</div>');
});

/* comfort messages */
document.querySelectorAll('.comfort').forEach(b=>{
  b.addEventListener('click', ()=> {
    const msg = b.dataset.msg || 'I am here.';
    showPopup(`<div style="font-weight:800;color:#d64b76">Comfort</div><div class="small" style="margin-top:6px">${msg}</div>`);
  });
});

/* im here button */
document.getElementById('imHere').addEventListener('click', ()=> {
  const echo = document.getElementById('hereEcho');
  echo.textContent = 'i am here with you üíó';
  echo.style.color = '#d64b76';
  littleFruitBurst(6);
  setTimeout(()=> echo.textContent = '', 2400);
});

/* ---------------------------
  Mini-game (Valorant) V2 - gun cursor + heart targets
--------------------------- */
const startMini = document.getElementById('startMini');
const resetMini = document.getElementById('resetMini');
const miniStage = document.getElementById('miniStage');
const miniTimer = document.getElementById('miniTimer');
const miniScore = document.getElementById('miniScore');

let gameRunning = false, gameScore = 0, gameTime = 20, spawnInt, gameInt, targets = [];

function randPos(w,h,pad=60){
  const x = Math.random()*(w - pad*2) + pad;
  const y = Math.random()*(h - pad*2) + pad;
  return {x,y};
}

function makeTarget(){
  const t = document.createElement('div');
  t.className = 'target';
  t.style.width = '52px'; t.style.height = '52px';
  const colors = ['#ff6b95','#ffd1e0','#ff9dbb','#d64b76','#ffb0c9'];
  t.style.background = colors[Math.floor(Math.random()*colors.length)];
  t.style.display = 'flex'; t.style.alignItems='center'; t.style.justifyContent='center'; t.style.fontSize='24px';
  t.innerHTML = '‚ù§';
  const rect = miniStage.getBoundingClientRect();
  const pos = randPos(rect.width, rect.height);
  t.style.left = (pos.x - 26) + 'px';
  t.style.top = (pos.y - 26) + 'px';
  // animate bobbing
  t.animate([{transform:'translateY(0)'},{transform:'translateY(-12px)'},{transform:'translateY(0)'}],{duration:(1800+Math.random()*800),iterations:Infinity,easing:'ease-in-out'});
  t.addEventListener('click', (e)=>{
    if(!gameRunning) return;
    gameScore++;
    miniScore.textContent = gameScore;
    // pop effect
    t.animate([{transform:'scale(1)'},{transform:'scale(1.6)',opacity:0}],{duration:220,easing:'ease-out'});
    setTimeout(()=> { try{ t.remove(); }catch(e){} }, 260);
    showFloating('Headshot!', e.clientX, e.clientY);
  });
  miniStage.appendChild(t);
  targets.push(t);
  // auto-remove after a while
  setTimeout(()=> { try{ t.remove(); }catch(e){} }, 4200 + Math.random()*1400);
}

function startMiniGame(){
  if(gameRunning) return;
  gameRunning = true; gameScore = 0; gameTime = 20; miniScore.textContent = 0; miniTimer.textContent = gameTime + 's';
  // show gun cursor
  gunCursor.style.display = 'flex';
  function moveGun(e){ gunCursor.style.left = e.clientX + 'px'; gunCursor.style.top = e.clientY + 'px'; }
  window.addEventListener('mousemove', moveGun);
  gunCursor._move = moveGun;
  // spawn loop
  spawnInt = setInterval(()=> {
    const n = 1 + Math.floor(Math.random()*2);
    for(let i=0;i<n;i++) makeTarget();
  }, 700);
  // initial burst
  for(let i=0;i<4;i++) setTimeout(makeTarget, i*180);
  // timer
  gameInt = setInterval(()=> {
    gameTime--;
    miniTimer.textContent = gameTime + 's';
    if(gameTime <= 0) endMiniGame();
  }, 1000);
}

function endMiniGame(){
  gameRunning = false;
  clearInterval(spawnInt); clearInterval(gameInt);
  // hide gun
  gunCursor.style.display = 'none';
  if(gunCursor._move) window.removeEventListener('mousemove', gunCursor._move);
  // clear targets
  targets.forEach(t => { try{ t.remove(); }catch(e){} });
  targets = [];
  showPopup(`<div style="font-weight:800;color:#d64b76">Round Over</div><div class="small" style="margin-top:8px">You scored <strong>${gameScore}</strong> ‚Äî ${gameScore>8? 'Headshot champ! üòç' : 'So cute, still my favorite.'}</div>`);
}

function resetMiniGame(){
  clearInterval(spawnInt); clearInterval(gameInt);
  targets.forEach(t => { try{ t.remove(); }catch(e){} });
  targets = []; gameRunning = false; gameScore = 0; gameTime = 20; miniScore.textContent = 0; miniTimer.textContent = '20s';
  gunCursor.style.display = 'none';
}

startMini.addEventListener('click', ()=> { resetMiniGame(); startMiniGame(); });
resetMini.addEventListener('click', resetMiniGame);

/* floating text helper */
function showFloating(text,x,y){
  const el = document.createElement('div');
  el.style.position='fixed'; el.style.left = x + 'px'; el.style.top = y + 'px';
  el.style.transform='translate(-50%,-50%)'; el.style.zIndex=9999; el.style.fontWeight='800'; el.style.color='#ff6b95';
  el.textContent = text; document.body.appendChild(el);
  el.animate([{opacity:1, transform:'translate(-50%,-50%) scale(1)'},{opacity:0, transform:'translate(-50%,-120%) scale(1.4)'}],{duration:900,easing:'ease-out'});
  setTimeout(()=> el.remove(),900);
}

/* position gun cursor initial */
window.addEventListener('mousemove', (e)=> {
  if(gunCursor.style.display === 'flex'){
    gunCursor.style.left = e.clientX + 'px';
    gunCursor.style.top = e.clientY + 'px';
  }
});

/* ---------------------------
  Simple chimes for music buttons (WebAudio)
--------------------------- */
let audioCtx;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function playChime(notes, durs){
  const ctx = ensureAudio(); const now = ctx.currentTime;
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='sine'; o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001, now);
  o.start(now);
  let t = now;
  for(let i=0;i<notes.length;i++){
    o.frequency.setValueAtTime(notes[i], t);
    g.gain.linearRampToValueAtTime(0.08, t+0.02);
    t += durs[i] || 0.2;
    g.gain.exponentialRampToValueAtTime(0.0001, t);
  }
  o.stop(t+0.05);
}
document.getElementById('jereBtn').addEventListener('click', ()=> playChime([330,392,523,440],[0.18,0.18,0.22,0.22]));
document.getElementById('nikiBtn').addEventListener('click', ()=> playChime([220,277,330,277],[0.2,0.2,0.3,0.2]));
document.getElementById('ariBtn').addEventListener('click', ()=> playChime([440,660,880,660,440],[0.12,0.12,0.18,0.12,0.2]));

/* close popup after click anywhere */
document.addEventListener('click', (e)=> {
  if(e.target.closest('.popup') === null) popup.classList.remove('show');
});

/* accessibility: keyboard to navigate chapters */
document.addEventListener('keydown', (e)=> {
  if(e.key === 'ArrowRight') switchChapter(Math.min(CH_COUNT, currentChapter+1));
  if(e.key === 'ArrowLeft') switchChapter(Math.max(1, currentChapter-1));
});

/* initialize first view */
function init(){
  switchChapter(1);
  // show gun cursor invisible by default
  gunCursor.style.display = 'none';
}
init();

/* cleanup on unload */
window.addEventListener('beforeunload', ()=> {
  try{ clearInterval(fruitTimer); }catch(e){}
});

</script>
</body>
</html>
